name: release-checklist

on:
  push:
    tags:
      - "v*"

jobs:
  checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify no python cache artifacts tracked
        run: |
          if git ls-files | grep -E '(__pycache__/|\.pyc$)' ; then
            echo "Found tracked python cache artifacts. Failing."
            exit 1
          fi

      - name: Verify CHANGELOG has this version
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md missing."
            exit 1
          fi
          if ! grep -qE "^##\s*(\[\s*)?${TAG}(\s*\])?" CHANGELOG.md; then
            echo "CHANGELOG.md missing section for ${TAG}"
            exit 1
          fi

      - name: Basic repository sanity
        run: |
          test -f .gitignore || (echo ".gitignore missing" && exit 1)
          echo "OK"
